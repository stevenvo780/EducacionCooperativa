#!/usr/bin/env bash
# edu-worker: Start a single worker container
# DEPRECATED: Use edu-worker-manager for multi-worker management
set -euo pipefail

ENV_FILE="${ENV_FILE:-/etc/edu-worker/worker.env}"
if [ -f "$ENV_FILE" ]; then
  set -a
  source "$ENV_FILE"
  set +a
fi

if ! command -v docker >/dev/null 2>&1; then
  echo "docker not installed" >&2
  exit 1
fi

WORKER_TOKEN="${WORKER_TOKEN:-}"
if [ -z "$WORKER_TOKEN" ]; then
  echo "WORKER_TOKEN required" >&2
  exit 1
fi

NEXUS_URL="${NEXUS_URL:-http://localhost:3010}"
MOUNT_PATH="${MOUNT_PATH:-/var/lib/edu-worker/workspace}"
FIREBASE_BUCKET="${FIREBASE_BUCKET:-}"
FIREBASE_CONFIG="${FIREBASE_CONFIG:-}"
WORKER_SECRET="${WORKER_SECRET:-}"
WORKER_IMAGE="${WORKER_IMAGE:-stevenvo780/edu-worker:latest}"
CONTAINER_NAME="${CONTAINER_NAME:-edu-worker}"
AUTO_PULL="${AUTO_PULL:-0}"

mkdir -p "$MOUNT_PATH"

if [ "$AUTO_PULL" = "1" ] || [ "$AUTO_PULL" = "true" ]; then
  docker pull "$WORKER_IMAGE"
fi

docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true

args=(run --rm --name "$CONTAINER_NAME" --network=host)
args+=(-e "NEXUS_URL=$NEXUS_URL")
args+=(-e "WORKER_TOKEN=$WORKER_TOKEN")

if [ -n "$WORKER_SECRET" ]; then
  args+=(-e "WORKER_SECRET=$WORKER_SECRET")
fi

if [ -n "$FIREBASE_CONFIG" ]; then
  args+=(-e "FIREBASE_CONFIG=$FIREBASE_CONFIG")
fi

if [ -n "$FIREBASE_BUCKET" ]; then
  args+=(-e "FIREBASE_BUCKET=$FIREBASE_BUCKET")
fi

args+=(-v "$MOUNT_PATH:/workspace")

exec docker "${args[@]}" "$WORKER_IMAGE"
