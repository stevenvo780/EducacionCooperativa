#!/usr/bin/env bash
# edu-worker-manager: Manage workspace workers as Docker containers
set -euo pipefail

# Load global config
CONFIG_FILE="/etc/edu-worker/worker.env"
if [ -f "$CONFIG_FILE" ]; then
  set -a
  source "$CONFIG_FILE"
  set +a
fi

# Configuration with defaults
WORKERS_CONFIG_DIR="${WORKERS_CONFIG_DIR:-/etc/edu-worker/workers.d}"
BASE_MOUNT_PATH="${BASE_MOUNT_PATH:-/home/humanizar/edu-worker}"
WORKER_IMAGE="${WORKER_IMAGE:-stevenvo780/edu-worker:latest}"
NEXUS_URL="${NEXUS_URL:-http://148.230.88.162:3010}"
WORKER_SECRET="${WORKER_SECRET:-}"
FIREBASE_CONFIG="${FIREBASE_CONFIG:-}"
FIREBASE_BUCKET="${FIREBASE_BUCKET:-}"

usage() {
  cat <<EOF
edu-worker-manager - Manage workspace workers

Usage: edu-worker-manager <command> [options]

Commands:
  add <workspace-id> [--name <name>] [--personal]
      Add and start a new workspace worker

  remove <workspace-id>
      Stop and remove a workspace worker

  start <workspace-id|all>
      Start worker(s)

  stop <workspace-id|all>
      Stop worker(s)

  restart <workspace-id|all>
      Restart worker(s)

  status [workspace-id]
      Show worker status (includes Workspace ID)

  ids
      List workspace IDs and names

  logs <workspace-id> [-f]
      Show worker logs

  update [workspace-id|all]
      Pull latest image and restart worker(s)

  resync <workspace-id|all>
      Force a full sync (restart worker without pulling image)

Examples:
  edu-worker-manager add myuserid --personal
  edu-worker-manager add Vt9HeKs --name "Griego"
  edu-worker-manager start all
  edu-worker-manager update all
  edu-worker-manager resync all

EOF
  exit 1
}

ensure_dirs() {
  mkdir -p "$WORKERS_CONFIG_DIR"
  mkdir -p "$BASE_MOUNT_PATH/workspaces"
}

get_container_name() {
  local id="$1"
  echo "edu-worker-${id}" | tr ':' '-' | tr -cd '[:alnum:]-_' | head -c 63
}

get_safe_path() {
  echo "$1" | tr ':' '_'
}

get_worker_token() {
  local id="$1"
  local type="$2"
  if [[ "$id" == personal:* ]]; then
    echo "$id"
  elif [ "$type" = "personal" ]; then
    echo "personal:$id"
  else
    echo "$id"
  fi
}

cmd_add() {
  local workspace_id=""
  local display_name=""
  local workspace_type="shared"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --name) display_name="$2"; shift 2 ;;
      --personal) workspace_type="personal"; shift ;;
      --type) workspace_type="$2"; shift 2 ;;
      -*) echo "Unknown option: $1" >&2; usage ;;
      *) [ -z "$workspace_id" ] && workspace_id="$1"; shift ;;
    esac
  done

  [ -z "$workspace_id" ] && { echo "Error: workspace-id required" >&2; usage; }
  [ -z "$display_name" ] && display_name="$workspace_id"

  ensure_dirs

  local safe_id=$(get_safe_path "$workspace_id")
  local config_file="${WORKERS_CONFIG_DIR}/${safe_id}.conf"
  local mount_path="${BASE_MOUNT_PATH}/workspaces/${safe_id}"

  mkdir -p "$mount_path"

  cat > "$config_file" <<EOF
WORKSPACE_ID="${workspace_id}"
WORKSPACE_NAME="${display_name}"
WORKSPACE_TYPE="${workspace_type}"
WORKER_TOKEN="$(get_worker_token "$workspace_id" "$workspace_type")"
MOUNT_PATH="${mount_path}"
EOF

  echo "✅ Added: ${display_name} (${workspace_id})"
  start_worker "$workspace_id"
}

cmd_remove() {
  local workspace_id="$1"
  [ -z "$workspace_id" ] && { echo "Error: workspace-id required" >&2; usage; }

  local safe_id=$(get_safe_path "$workspace_id")
  local config_file="${WORKERS_CONFIG_DIR}/${safe_id}.conf"
  local container_name=$(get_container_name "$workspace_id")

  docker stop "$container_name" 2>/dev/null || true
  docker rm -f "$container_name" 2>/dev/null || true

  [ -f "$config_file" ] && rm -f "$config_file" && echo "✅ Removed: ${workspace_id}"
}

start_worker() {
  local requested_id="$1"
  local safe_id=$(get_safe_path "$requested_id")
  local config_file="${WORKERS_CONFIG_DIR}/${safe_id}.conf"

  # Fallback: if caller passed safe_id, use it; otherwise error
  if [ ! -f "$config_file" ]; then
    local alt_config="${WORKERS_CONFIG_DIR}/${requested_id}.conf"
    if [ -f "$alt_config" ]; then
      config_file="$alt_config"
    else
      echo "❌ Config not found: $requested_id" >&2
      return 1
    fi
  fi

  # Save global config before sourcing worker-specific config
  local _WORKER_SECRET="$WORKER_SECRET"
  local _FIREBASE_CONFIG="$FIREBASE_CONFIG"
  local _FIREBASE_BUCKET="$FIREBASE_BUCKET"
  
  # Validate critical variables
  if [ -z "$_WORKER_SECRET" ]; then
    echo "❌ ERROR: WORKER_SECRET not set in /etc/edu-worker/worker.env"
    echo "   Run this command with sudo, or check your configuration."
    return 1
  fi
  if [ -z "$_FIREBASE_CONFIG" ]; then
    echo "❌ ERROR: FIREBASE_CONFIG not set in /etc/edu-worker/worker.env"
    echo "   Run this command with sudo, or check your configuration."
    return 1
  fi
  
  source "$config_file"
  local effective_id="${WORKSPACE_ID:-$requested_id}"
  local container_name=$(get_container_name "$effective_id")

  docker rm -f "$container_name" 2>/dev/null || true

  local args=(run -d --name "$container_name" --network=host --restart unless-stopped)
  args+=(-e "NEXUS_URL=$NEXUS_URL")
  args+=(-e "WORKER_TOKEN=$WORKER_TOKEN")
  args+=(-e "WORKER_SECRET=$_WORKER_SECRET")
  args+=(-e "FIREBASE_CONFIG=$_FIREBASE_CONFIG")
  [ -n "$_FIREBASE_BUCKET" ] && args+=(-e "FIREBASE_BUCKET=$_FIREBASE_BUCKET")
  args+=(-v "${MOUNT_PATH}:/workspace")

  docker "${args[@]}" "$WORKER_IMAGE" >/dev/null
  echo "✅ Started: ${WORKSPACE_NAME:-$effective_id}"
}

cmd_start() {
  local target="${1:-}"
  [ -z "$target" ] && { echo "Error: workspace-id or 'all' required" >&2; usage; }

  ensure_dirs

  if [ "$target" = "all" ]; then
    local count=0
    for conf in "${WORKERS_CONFIG_DIR}"/*.conf; do
      [ -f "$conf" ] || continue
      source "$conf"
      local ws_id="${WORKSPACE_ID:-$(basename "$conf" .conf)}"
      start_worker "$ws_id" && ((count++)) || true
    done
    echo "Started $count worker(s)"
  else
    start_worker "$target"
  fi
}

cmd_stop() {
  local target="${1:-}"
  [ -z "$target" ] && { echo "Error: workspace-id or 'all' required" >&2; usage; }

  if [ "$target" = "all" ]; then
    for conf in "${WORKERS_CONFIG_DIR}"/*.conf; do
      [ -f "$conf" ] || continue
      source "$conf"
      local container_name=$(get_container_name "${WORKSPACE_ID:-$(basename "$conf" .conf)}")
      docker stop "$container_name" 2>/dev/null && echo "Stopped: $WORKSPACE_ID" || true
    done
  else
    docker stop "$(get_container_name "$target")" 2>/dev/null && echo "Stopped: $target" || echo "Not running: $target"
  fi
}

cmd_restart() {
  cmd_stop "${1:-}"
  sleep 1
  cmd_start "${1:-}"
}

cmd_update() {
  local target="${1:-all}"
  echo "Pulling latest image..."
  docker pull "$WORKER_IMAGE"
  cmd_restart "$target"
}

cmd_resync() {
  local target="${1:-all}"
  echo "Forzando resync (reinicio sin pull)..."
  cmd_restart "$target"
}

cmd_status() {
  ensure_dirs
  printf "%-36s %-24s %-10s %-10s %-8s\n" "WORKSPACE_ID" "NAME" "TYPE" "STATUS" "RTDB"
  printf "%-36s %-24s %-10s %-10s %-8s\n" "------------------------------------" "------------------------" "----------" "----------" "--------"

  for conf in "${WORKERS_CONFIG_DIR}"/*.conf; do
    [ -f "$conf" ] || continue
    source "$conf"
    local ws_id="${WORKSPACE_ID:-$(basename "$conf" .conf)}"
    local container_name=$(get_container_name "$ws_id")
    local status="stopped"
    local rtdb="-"

    if docker ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
      status="running"
      rtdb=$(docker logs "$container_name" 2>&1 | grep -c "✅ Listener de RTDB activo" || echo 0)
    fi

    local name="${WORKSPACE_NAME:-$ws_id}"
    [ ${#name} -gt 22 ] && name="${name:0:19}..."
    printf "%-36s %-24s %-10s %-10s %-8s\n" "$ws_id" "$name" "${WORKSPACE_TYPE:-shared}" "$status" "$rtdb"
  done
}

cmd_ids() {
  ensure_dirs
  printf "%-36s %-24s %-10s\n" "WORKSPACE_ID" "NAME" "TYPE"
  printf "%-36s %-24s %-10s\n" "------------------------------------" "------------------------" "----------"
  for conf in "${WORKERS_CONFIG_DIR}"/*.conf; do
    [ -f "$conf" ] || continue
    source "$conf"
    local ws_id="${WORKSPACE_ID:-$(basename "$conf" .conf)}"
    local name="${WORKSPACE_NAME:-$ws_id}"
    [ ${#name} -gt 22 ] && name="${name:0:19}..."
    printf "%-36s %-24s %-10s\n" "$ws_id" "$name" "${WORKSPACE_TYPE:-shared}"
  done
}

cmd_logs() {
  local workspace_id="$1"; shift || true
  local follow=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -f|--follow) follow="-f"; shift ;;
      *) shift ;;
    esac
  done
  [ -z "$workspace_id" ] && { echo "Error: workspace-id required" >&2; usage; }
  docker logs $follow "$(get_container_name "$workspace_id")"
}
        
# Main
[ $# -lt 1 ] && usage

cmd="$1"; shift

case "$cmd" in
  add) cmd_add "$@" ;;
  remove|rm) cmd_remove "${1:-}" ;;
  start) cmd_start "${1:-}" ;;
  stop) cmd_stop "${1:-}" ;;
  restart) cmd_restart "${1:-}" ;;
  update) cmd_update "${1:-}" ;;
  resync) cmd_resync "${1:-}" ;;
  status|list|ls) cmd_status ;;
  ids) cmd_ids ;;
  logs) cmd_logs "$@" ;;
  help|--help|-h) usage ;;
  *) echo "Unknown command: $cmd" >&2; usage ;;
esac
