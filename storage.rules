rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSyncAgentFor(id) {
      return isAuthenticated() && request.auth.uid == 'sync-agent:' + id;
    }

    function isUserOrAgent(userId) {
      return isAuthenticated() && (request.auth.uid == userId || isSyncAgentFor(userId));
    }

    function isWorkspaceAuthorized(workspaceId) {
      // NOTE: No membership checks here; relies on app logic.
      return isAuthenticated() || isSyncAgentFor(workspaceId);
    }

    function isAllowedTextContentType() {
      return request.resource != null &&
             request.resource.contentType != null && (
               request.resource.contentType.matches('^text/.*') ||
               request.resource.contentType.matches('^application/(json|xml|yaml|x-yaml|toml)$')
             );
    }

    function isBlockedScriptExtension(path) {
      return path.matches('.*\\.(js|jsx|ts|tsx|mjs|cjs|sh|bash|zsh|ps1|bat|cmd|py|rb|php|pl|go|java|kt|cs|swift|rs|scala|lua|r|sql)$');
    }

    function isAllowedTextFile(path) {
      return isAllowedTextContentType() && !isBlockedScriptExtension(path);
    }
    
    // Personal user storage: users/{userId}/...
    match /users/{userId}/{filePath=**} {
      // User can access their own files
      allow read: if isUserOrAgent(userId);
      allow create, update: if isUserOrAgent(userId) && isAllowedTextFile(filePath);
      allow delete: if isUserOrAgent(userId);
    }
    
    // Shared workspace storage: workspaces/{workspaceId}/...
    match /workspaces/{workspaceId}/{filePath=**} {
      // Members can access workspace files
      // Note: We can't check Firestore from Storage rules directly,
      // so we rely on the sync-agent having the correct workspaceId
      allow read: if isWorkspaceAuthorized(workspaceId);
      allow create, update: if isWorkspaceAuthorized(workspaceId) && isAllowedTextFile(filePath);
      allow delete: if isWorkspaceAuthorized(workspaceId);
    }
  }
}
